"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.runL1XmlVarSubTests = void 0;
const path = require("path");
const assert = require("assert");
const ltx = require("ltx");
const fs = require("fs");
const tl = require("azure-pipelines-task-lib");
const xmlvariablesubstitutionutility_1 = require("../xmlvariablesubstitutionutility");
const fileencoding_1 = require("../fileencoding");
function runL1XmlVarSubTests() {
    this.timeout(60000);
    beforeEach(function (done) {
        tl.cp(getAbsolutePath('Web.config'), getAbsolutePath('Web_test.config'), '-f', false);
        tl.cp(getAbsolutePath('Web.Debug.config'), getAbsolutePath('Web_test.Debug.config'), '-f', false);
        tl.cp(getAbsolutePath('parameters.xml'), getAbsolutePath('parameters_test.xml'), '-f', false);
        done();
    });
    afterEach(done => {
        try {
            tl.rmRF(getAbsolutePath('parameters_test.xml'));
            tl.rmRF(getAbsolutePath('Web_test.Debug.config'));
            tl.rmRF(getAbsolutePath('Web_test.config'));
        }
        catch (error) {
            tl.debug(error);
        }
        finally {
            done();
        }
    });
    it("Runs successfully with XML variable substitution", done => {
        const parameterFilePath = getAbsolutePath('parameters_test.xml');
        const tags = ["applicationSettings", "appSettings", "connectionStrings", "configSections"];
        const variableMap = {
            'conntype': 'new_connType',
            "MyDB": "TestDB",
            'webpages:Version': '1.1.7.3',
            'xdt:Transform': 'DelAttributes',
            'xdt:Locator': 'Match(tag)',
            'DefaultConnection': "Url=https://primary;Database=db1;ApiKey=11111111-1111-1111-1111-111111111111;Failover = {Url:'https://secondary', ApiKey:'11111111-1111-1111-1111-111111111111'}",
            'OtherDefaultConnection': 'connectionStringValue2',
            'ParameterConnection': 'New_Connection_String From xml var subs',
            'connectionString': 'replaced_value',
            'invariantName': 'System.Data.SqlServer',
            'blatvar': 'ApplicationSettingReplacedValue',
            'log_level': 'error,warning',
            'Email:ToOverride': ''
        };
        xmlvariablesubstitutionutility_1.substituteXmlVariables(getAbsolutePath('Web_test.config'), tags, variableMap, parameterFilePath);
        xmlvariablesubstitutionutility_1.substituteXmlVariables(getAbsolutePath('Web_test.Debug.config'), tags, variableMap, parameterFilePath);
        assert(compareXmlFiles('Web_test.config', 'Web_Expected.config'), 'Should have substituted variables in Web.config file');
        assert(compareXmlFiles('Web_test.Debug.config', 'Web_Expected.Debug.config'), 'Should have substituted variables in Web.Debug.config file');
        assert(compareXmlFiles('parameters_test.xml', 'parameters_Expected.xml'), 'Should have substituted variables in parameters.xml file');
        done();
    });
    function getAbsolutePath(file) {
        return path.join(__dirname, 'L1XmlVarSub', file);
    }
    function compareXmlFiles(actualFile, expectedFile) {
        const actualFilePath = getAbsolutePath(actualFile);
        const expectedFilePath = getAbsolutePath(expectedFile);
        var actualXml = ltx.parse(readFile(actualFilePath));
        var expectedXml = ltx.parse(readFile(expectedFilePath));
        return ltx.equal(actualXml, expectedXml);
    }
    function readFile(path) {
        const buffer = fs.readFileSync(path);
        const encoding = fileencoding_1.detectFileEncoding(path, buffer)[0].toString();
        return buffer.toString(encoding).replace(/(?<!\r)[\n]+/gm, "\r\n");
    }
}
exports.runL1XmlVarSubTests = runL1XmlVarSubTests;
